# কমিশন সিস্টেম ধারণা

## ১. কমিশন জেনারেশন আচরণ
- পেমেন্ট এন্ট্রি হলেই কমিশন "paid" হিসেবে সেভ হয় না।
- প্রতিটি পেমেন্টের পর সিস্টেম শুধুমাত্র কমিশন হিসাব করে preview/report আকারে ধরে রাখে।
- এই হিসাবগুলো ডাটাবেসে অপরিশোধিত (unpaid) অবস্থায় থেকে যায় যতক্ষণ না অ্যাডমিন অনুমোদন দেয়।

## ২. মাসিক প্রশাসনিক প্রসেস
1. মাস শেষে অ্যাডমিন "Commission Calculation Report" চালায়।
2. রিপোর্টে পুরো মাসের সকল বিক্রয় অনুযায়ী প্রত্যেকের কমিশন payable/unpaid অবস্থায় দেখায়।
3. যাচাই শেষে অ্যাডমিন "Process/Approve" বাটনে ক্লিক করলে:
   - প্রতিটি কমিশন রেকর্ড ডাটাবেসে insert হয়ে "paid" স্ট্যাটাস পায়।
   - সংশ্লিষ্ট কর্মীর ওয়ালেট ব্যালেন্সে কমিশন যোগ হয়।

## ৩. কর্মচারীদের ভিউ
- কর্মীরা (ME/MM/AGM/DGM/GM) দৈনিক বা মাসিক ভিত্তিতে তাদের সম্ভাব্য কমিশন দেখতে পারে।
- এসব পরিমাণ সবসময় unpaid/payable অবস্থায় থাকে যতক্ষণ না অ্যাডমিন অনুমোদন দেয়।
- অনুমোদনের আগ পর্যন্ত ওয়ালেট ব্যালেন্স অপরিবর্তিত থাকে।

## ৪. কমিশন ক্যালকুলেশন ইউনিট (CCU)
- প্রতিটি পেমেন্ট বা সেলের জন্য আলাদা CCU তৈরি হয় এবং `commission_calculation_units` টেবিলে `draft` স্ট্যাটাসে সেভ থাকে।
- প্রতিটি CCU-এর বিস্তারিত ব্রেকডাউন `commission_calculation_items` টেবিলে সংরক্ষিত হয়, যেখানে প্রত্যেক রিসিপিয়েন্টের সম্ভাব্য কমিশন আলাদা এন্ট্রি হিসেবে থাকে।
- CCU স্ট্যাটাস:
  - `draft/unpaid`: অ্যাডমিন এখনো অনুমোদন দেয়নি।
  - `paid`: অ্যাডমিন রিপোর্ট প্রসেস করে অনুমোদন দিয়েছে এবং সংশ্লিষ্ট কমিশনগুলো `commissions` টেবিলে paid হিসেবে তৈরি হয়েছে।

## ৫. কমিশন ফ্লো (স্টেপ-বাই-স্টেপ)
| ধাপ | কী হবে | দায়িত্বপ্রাপ্ত |
| --- | --- | --- |
| 1️⃣ | পেমেন্ট রেকর্ড হবে | সিস্টেম |
| 2️⃣ | CCU (কমিশন ব্রেকডাউনসহ) অটো জেনারেট হবে | সিস্টেম |
| 3️⃣ | কর্মীরা তাদের payable কমিশন রিপোর্টে দেখতে পারবে | সিস্টেম |
| 4️⃣ | মাস শেষে অ্যাডমিন "Commission Process" চালাবে | অ্যাডমিন |
| 5️⃣ | কমিশন paid হয়ে ওয়ালেটে ক্রেডিট হবে | সিস্টেম |

## ৬. গ্যাপ কমিশন রুল (ডেভেলপমেন্ট র‍্যাঙ্ক লজিক)
- মোট কমিশন সবসময় ডাউন-পেমেন্টের ৩০%।
- পূর্ণ র্যাঙ্ক চেইন (ME → MM → AGM → DGM → GM) উপস্থিত থাকলে প্রত্যেকে তাদের নির্ধারিত শতাংশ পায়।
- কোনো মধ্যবর্তী র‍্যাঙ্ক অনুপস্থিত থাকলে, উপরের র‍্যাঙ্কের ব্যক্তি ওই গ্যাপের শতাংশ পায়।
- উদাহরণ: GM সরাসরি ME নিয়ে এসেছে →
  - ME পাবে ১০%
  - GM পাবে বাকি ২০% (AGM/DGM অনুপস্থিত থাকায় তাদের অংশ GM-এর কাছে যায়)

## ৭. সারসংক্ষেপ
"Sales বা Payment-এর সাথে সাথে কমিশন system-এ paid হিসেবে যায় না। বরং প্রতিটি পেমেন্টের জন্য CCU (Commission Calculation Unit) তৈরি হয়, যেখানে প্রত্যেক কর্মীর সম্ভাব্য কমিশনের হিসাব থাকে।

কর্মীরা প্রতিদিন বা মাসজুড়ে তাদের payable/unpaid কমিশন রিপোর্ট দেখতে পারে, কিন্তু টাকাটা তখনও wallet-এ যোগ হয় না।

মাসের শেষে অ্যাডমিন পুরো রিপোর্ট দেখে ‘Process’ করলে তবেই কমিশনগুলো paid হয় এবং প্রত্যেকের wallet-এ টাকা যোগ হয়। ফলে কমিশন হিসাব আলাদাভাবে verify ও approve করা যায় এবং ব্যবসায়িক দল মাসিক settlement-এর মাধ্যমে payment clear করতে পারে।"

## ৮. এপিআই ও টুলস
- **Pending CCU রিপোর্ট (Admin / Finance):**
  - `GET /api/v1/commission-calculations`
    - ডিফল্টভাবে শুধুমাত্র `draft` স্ট্যাটাসের CCU দেখায়।
    - `include=items,payment.salesOrder.agent.user` ব্যবহার করলে ব্রেকডাউন, সেলস অর্ডার ও সম্পর্কিত পার্টি তথ্য একসাথে দেখা যায়।
    - `from`/`to` (Payment `paid_at`), `branch_id`, `agent_id`, `recipient_type`, `recipient_id` ফিল্টার দিয়ে মাসিক বা নির্দিষ্ট কর্মীর রিপোর্ট বের করা যায়।
    - রেসপন্সে `summary` অংশে মোট CCU সংখ্যা, মোট আইটেম ও মোট টাকার পরিমাণ দেখা যায়।
- **একক CCU ডিটেইল:**
  - `GET /api/v1/commission-calculations/{id}` → নির্দিষ্ট পেমেন্টের কমিশন ব্রেকডাউন দেখা যায়।
- **মাসিক প্রসেসিং (Approve বাটনের সমতুল্য):**
  - `POST /api/v1/commission-calculations/process` (ঐচ্ছিক `date`/`up_to` প্যারামিটার সহ)
    - নির্দিষ্ট তারিখ পর্যন্ত সব draft CCU প্রসেস করে `commissions` টেবিলে paid এন্ট্রি তৈরি করে এবং এমপ্লয়ি ওয়ালেট ক্রেডিট করে।
    - রেসপন্সে কতগুলো কমিশন প্রসেস হয়েছে এবং মোট কত টাকা পে-আউট হয়েছে তা দেখায়।
- **CLI সাপোর্ট:**
  - `php artisan commissions:process --date=2025-10-31` কমান্ড দিয়ে একই কাজ ব্যাচ প্রসেস হিসেবে চালানো যায়।

এই API গুলোর মাধ্যমে কর্মীরা নিজেদের সম্ভাব্য কমিশন ফিল্টার করে দেখতে পারে (`recipient_type=App\Models\Employee` & `recipient_id=<employee_id>`), এবং অ্যাডমিন টিম মাসের শেষে একই ডেটাসেট যাচাই করে এক ক্লিকেই প্রসেস করতে পারে।
